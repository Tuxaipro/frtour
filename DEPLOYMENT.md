# Deployment Guide - Travel OnePage CMS

This guide provides step-by-step instructions for deploying the Travel OnePage CMS application to a production server.

## Table of Contents

1. [Server Requirements](#server-requirements)
2. [Pre-Deployment Checklist](#pre-deployment-checklist)
3. [Server Setup](#server-setup)
4. [Application Deployment](#application-deployment)
5. [Database Setup](#database-setup)
6. [Environment Configuration](#environment-configuration)
7. [Asset Compilation](#asset-compilation)
8. [File Permissions](#file-permissions)
9. [Web Server Configuration](#web-server-configuration)
10. [SSL Certificate Setup](#ssl-certificate-setup)
11. [Post-Deployment Verification](#post-deployment-verification)
12. [Troubleshooting](#troubleshooting)

---

## Server Requirements

### Minimum Requirements
- **PHP**: 8.1 or higher
- **Database**: PostgreSQL 12+ or MySQL 8.0+ or MariaDB 10.3+
- **Web Server**: Nginx 1.18+ or Apache 2.4+
- **Composer**: 2.0+
- **Node.js**: 18.x or 20.x
- **NPM**: 9.x or higher

### PHP Extensions Required
```bash
php -m | grep -E "pdo|pdo_pgsql|pdo_mysql|mbstring|xml|openssl|json|tokenizer|fileinfo|gd|curl|zip"
```

Required extensions:
- `pdo`
- `pdo_pgsql` or `pdo_mysql`
- `mbstring`
- `xml`
- `openssl`
- `json`
- `tokenizer`
- `fileinfo`
- `gd` (for image processing)
- `curl`
- `zip`

### Server Resources
- **RAM**: Minimum 512MB, Recommended 1GB+
- **Storage**: Minimum 2GB free space
- **CPU**: 1 core minimum, 2+ cores recommended

---

## Pre-Deployment Checklist

- [ ] Server meets all requirements
- [ ] Domain name configured and pointing to server IP
- [ ] Database server is accessible
- [ ] SSH access to server is configured
- [ ] Git repository is accessible
- [ ] Backup strategy is in place
- [ ] SSL certificate is ready (or Let's Encrypt setup)

---

## Server Setup

### 1. Update System Packages

```bash
# Ubuntu/Debian
sudo apt update && sudo apt upgrade -y

# CentOS/RHEL
sudo yum update -y
```

### 2. Install PHP and Required Extensions

```bash
# Ubuntu/Debian
sudo apt install -y php8.2 php8.2-fpm php8.2-cli php8.2-common \
    php8.2-mbstring php8.2-xml php8.2-curl php8.2-zip php8.2-gd \
    php8.2-pgsql php8.2-mysql php8.2-bcmath php8.2-tokenizer \
    php8.2-fileinfo php8.2-opcache

# CentOS/RHEL
sudo yum install -y php82 php82-php-fpm php82-php-cli php82-php-common \
    php82-php-mbstring php82-php-xml php82-php-curl php82-php-zip \
    php82-php-gd php82-php-pgsql php82-php-mysqlnd php82-php-bcmath \
    php82-php-opcache
```

### 3. Install Composer

```bash
cd ~
curl -sS https://getcomposer.org/installer | php
sudo mv composer.phar /usr/local/bin/composer
sudo chmod +x /usr/local/bin/composer
composer --version
```

### 4. Install Node.js and NPM

```bash
# Using NodeSource repository (Ubuntu/Debian)
curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
sudo apt install -y nodejs

# Verify installation
node --version
npm --version
```

### 5. Install Database Server

#### PostgreSQL
```bash
# Ubuntu/Debian
sudo apt install -y postgresql postgresql-contrib

# Start and enable PostgreSQL
sudo systemctl start postgresql
sudo systemctl enable postgresql
```

#### MySQL/MariaDB
```bash
# Ubuntu/Debian
sudo apt install -y mysql-server

# Secure installation
sudo mysql_secure_installation
```

### 6. Install Web Server

#### Nginx
```bash
# Ubuntu/Debian
sudo apt install -y nginx

# Start and enable Nginx
sudo systemctl start nginx
sudo systemctl enable nginx
```

#### Apache (Alternative)
```bash
# Ubuntu/Debian
sudo apt install -y apache2 libapache2-mod-php8.2

# Enable required modules
sudo a2enmod rewrite
sudo a2enmod ssl
sudo systemctl restart apache2
```

---

## Application Deployment

### 1. Create Application Directory

```bash
# Create directory for application
sudo mkdir -p /var/www/travel-cms
sudo chown -R $USER:$USER /var/www/travel-cms
cd /var/www/travel-cms
```

### 2. Clone Repository

```bash
# Clone your repository
git clone https://github.com/your-username/travel-onepage-cms.git .

# Or if using SSH
git clone git@github.com:your-username/travel-onepage-cms.git .
```

### 3. Install PHP Dependencies

```bash
# Install production dependencies
composer install --optimize-autoloader --no-dev

# If you need dev dependencies for building assets
composer install --optimize-autoloader
```

### 4. Set Up Environment File

```bash
# Copy environment file
cp .env.example .env

# Generate application key
php artisan key:generate
```

### 5. Configure Environment Variables

Edit `.env` file with your production settings:

```bash
nano .env
```

**Required Configuration:**

```env
APP_NAME="Travel CMS"
APP_ENV=production
APP_KEY=base64:... (generated by key:generate)
APP_DEBUG=false
APP_URL=https://yourdomain.com

LOG_CHANNEL=stack
LOG_LEVEL=error

DB_CONNECTION=pgsql
DB_HOST=127.0.0.1
DB_PORT=5432
DB_DATABASE=travel_cms
DB_USERNAME=your_db_user
DB_PASSWORD=your_secure_password

BROADCAST_DRIVER=log
CACHE_DRIVER=file
FILESYSTEM_DISK=local
QUEUE_CONNECTION=sync
SESSION_DRIVER=file
SESSION_LIFETIME=120

MEMCACHED_HOST=127.0.0.1

REDIS_HOST=127.0.0.1
REDIS_PASSWORD=null
REDIS_PORT=6379

MAIL_MAILER=smtp
MAIL_HOST=mailpit
MAIL_PORT=1025
MAIL_USERNAME=null
MAIL_PASSWORD=null
MAIL_ENCRYPTION=null
MAIL_FROM_ADDRESS="hello@example.com"
MAIL_FROM_NAME="${APP_NAME}"
```

---

## Database Setup

### 1. Create Database and User

#### PostgreSQL
```bash
# Switch to postgres user
sudo -u postgres psql

# Create database and user
CREATE DATABASE travel_cms;
CREATE USER travel_user WITH ENCRYPTED PASSWORD 'your_secure_password';
GRANT ALL PRIVILEGES ON DATABASE travel_cms TO travel_user;
\q
```

#### MySQL/MariaDB
```bash
# Login to MySQL
sudo mysql -u root -p

# Create database and user
CREATE DATABASE travel_cms CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
CREATE USER 'travel_user'@'localhost' IDENTIFIED BY 'your_secure_password';
GRANT ALL PRIVILEGES ON travel_cms.* TO 'travel_user'@'localhost';
FLUSH PRIVILEGES;
EXIT;
```

### 2. Run Migrations

```bash
cd /var/www/travel-cms

# Run migrations
php artisan migrate --force

# Optional: Seed initial data
php artisan db:seed --force
```

---

## Asset Compilation

### 1. Install NPM Dependencies

```bash
# Install Node dependencies
npm install
```

### 2. Build Production Assets

```bash
# Build for production
npm run build

# This will create optimized assets in public/build/
```

### 3. Verify Build

```bash
# Check if build directory exists
ls -la public/build/

# Should see manifest.json and asset files
```

---

## File Permissions

### 1. Set Correct Ownership

```bash
# Set ownership (replace 'www-data' with your web server user)
sudo chown -R www-data:www-data /var/www/travel-cms

# Or if using nginx with different user
sudo chown -R nginx:nginx /var/www/travel-cms
```

### 2. Set Directory Permissions

```bash
cd /var/www/travel-cms

# Set directory permissions
sudo find . -type d -exec chmod 755 {} \;

# Set file permissions
sudo find . -type f -exec chmod 644 {} \;
```

### 3. Set Storage and Cache Permissions

```bash
# Make storage and cache writable
sudo chmod -R 775 storage bootstrap/cache
sudo chown -R www-data:www-data storage bootstrap/cache

# Create storage link
php artisan storage:link
```

---

## Web Server Configuration

### Nginx Configuration

Create Nginx configuration file:

```bash
sudo nano /etc/nginx/sites-available/travel-cms
```

**Nginx Configuration:**

```nginx
server {
    listen 80;
    listen [::]:80;
    server_name yourdomain.com www.yourdomain.com;
    root /var/www/travel-cms/public;

    add_header X-Frame-Options "SAMEORIGIN";
    add_header X-Content-Type-Options "nosniff";

    index index.php;

    charset utf-8;

    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }

    location = /favicon.ico { access_log off; log_not_found off; }
    location = /robots.txt  { access_log off; log_not_found off; }

    error_page 404 /index.php;

    location ~ \.php$ {
        fastcgi_pass unix:/var/run/php/php8.2-fpm.sock;
        fastcgi_param SCRIPT_FILENAME $realpath_root$fastcgi_script_name;
        include fastcgi_params;
        fastcgi_hide_header X-Powered-By;
    }

    location ~ /\.(?!well-known).* {
        deny all;
    }

    # Cache static assets
    location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
}
```

**Enable Site:**

```bash
# Create symbolic link
sudo ln -s /etc/nginx/sites-available/travel-cms /etc/nginx/sites-enabled/

# Remove default site (optional)
sudo rm /etc/nginx/sites-enabled/default

# Test Nginx configuration
sudo nginx -t

# Reload Nginx
sudo systemctl reload nginx
```

### Apache Configuration

Create Apache virtual host:

```bash
sudo nano /etc/apache2/sites-available/travel-cms.conf
```

**Apache Configuration:**

```apache
<VirtualHost *:80>
    ServerName yourdomain.com
    ServerAlias www.yourdomain.com
    DocumentRoot /var/www/travel-cms/public

    <Directory /var/www/travel-cms/public>
        AllowOverride All
        Require all granted
    </Directory>

    ErrorLog ${APACHE_LOG_DIR}/travel-cms-error.log
    CustomLog ${APACHE_LOG_DIR}/travel-cms-access.log combined
</VirtualHost>
```

**Enable Site:**

```bash
# Enable site
sudo a2ensite travel-cms.conf

# Disable default site
sudo a2dissite 000-default.conf

# Test Apache configuration
sudo apache2ctl configtest

# Restart Apache
sudo systemctl restart apache2
```

---

## SSL Certificate Setup

### Using Let's Encrypt (Certbot)

```bash
# Install Certbot
sudo apt install -y certbot python3-certbot-nginx
# Or for Apache:
sudo apt install -y certbot python3-certbot-apache

# Obtain SSL certificate for Nginx
sudo certbot --nginx -d yourdomain.com -d www.yourdomain.com

# Or for Apache
sudo certbot --apache -d yourdomain.com -d www.yourdomain.com

# Test auto-renewal
sudo certbot renew --dry-run
```

### Update Nginx for HTTPS

Certbot will automatically update your Nginx configuration. Manual configuration:

```nginx
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name yourdomain.com www.yourdomain.com;
    root /var/www/travel-cms/public;

    ssl_certificate /etc/letsencrypt/live/yourdomain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/yourdomain.com/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;

    # ... rest of configuration same as above
}

# Redirect HTTP to HTTPS
server {
    listen 80;
    listen [::]:80;
    server_name yourdomain.com www.yourdomain.com;
    return 301 https://$server_name$request_uri;
}
```

---

## Post-Deployment Verification

### 1. Clear Application Cache

```bash
cd /var/www/travel-cms

# Clear all caches
php artisan config:clear
php artisan cache:clear
php artisan route:clear
php artisan view:clear

# Cache configuration for production
php artisan config:cache
php artisan route:cache
php artisan view:cache
```

### 2. Optimize Application

```bash
# Optimize autoloader
composer install --optimize-autoloader --no-dev

# Optimize Laravel
php artisan optimize
```

### 3. Test Application

- [ ] Visit homepage: `https://yourdomain.com`
- [ ] Test admin login: `https://yourdomain.com/admin`
- [ ] Verify database connection
- [ ] Test file uploads (images)
- [ ] Test quote request form submission
- [ ] Verify email sending (if configured)
- [ ] Check error logs

### 4. Monitor Logs

```bash
# Laravel logs
tail -f storage/logs/laravel.log

# Nginx error logs
sudo tail -f /var/log/nginx/error.log

# PHP-FPM logs
sudo tail -f /var/log/php8.2-fpm.log
```

---

## Scheduled Tasks (Cron Jobs)

Laravel requires a cron job to run scheduled tasks:

```bash
# Edit crontab
sudo crontab -e -u www-data

# Add this line (replace path with your actual path)
* * * * * cd /var/www/travel-cms && php artisan schedule:run >> /dev/null 2>&1
```

---

## Queue Workers (If Using Queues)

If you configure queues in the future:

```bash
# Create systemd service for queue worker
sudo nano /etc/systemd/system/travel-cms-queue.service
```

**Service File:**

```ini
[Unit]
Description=Travel CMS Queue Worker
After=network.target

[Service]
User=www-data
Group=www-data
Restart=always
ExecStart=/usr/bin/php /var/www/travel-cms/artisan queue:work --sleep=3 --tries=3 --max-time=3600

[Install]
WantedBy=multi-user.target
```

**Enable and Start:**

```bash
sudo systemctl enable travel-cms-queue
sudo systemctl start travel-cms-queue
sudo systemctl status travel-cms-queue
```

---

## Backup Strategy

### 1. Database Backup Script

Create backup script:

```bash
sudo nano /usr/local/bin/backup-travel-cms.sh
```

**Backup Script:**

```bash
#!/bin/bash
BACKUP_DIR="/var/backups/travel-cms"
DATE=$(date +%Y%m%d_%H%M%S)
DB_NAME="travel_cms"
DB_USER="travel_user"

# Create backup directory
mkdir -p $BACKUP_DIR

# Backup database
pg_dump -U $DB_USER $DB_NAME | gzip > $BACKUP_DIR/db_$DATE.sql.gz

# Backup storage files
tar -czf $BACKUP_DIR/storage_$DATE.tar.gz /var/www/travel-cms/storage/app

# Keep only last 7 days of backups
find $BACKUP_DIR -type f -mtime +7 -delete

echo "Backup completed: $DATE"
```

**Make executable and schedule:**

```bash
sudo chmod +x /usr/local/bin/backup-travel-cms.sh

# Add to crontab (daily at 2 AM)
sudo crontab -e
# Add: 0 2 * * * /usr/local/bin/backup-travel-cms.sh
```

---

## Troubleshooting

### Common Issues

#### 1. 500 Internal Server Error

```bash
# Check Laravel logs
tail -f storage/logs/laravel.log

# Check file permissions
ls -la storage bootstrap/cache

# Clear cache
php artisan cache:clear
php artisan config:clear
```

#### 2. Permission Denied Errors

```bash
# Fix ownership
sudo chown -R www-data:www-data /var/www/travel-cms
sudo chmod -R 775 storage bootstrap/cache
```

#### 3. Database Connection Error

```bash
# Test database connection
php artisan tinker
# Then: DB::connection()->getPdo();

# Check .env file
cat .env | grep DB_
```

#### 4. Assets Not Loading

```bash
# Rebuild assets
npm run build

# Clear view cache
php artisan view:clear

# Check public/build directory exists
ls -la public/build/
```

#### 5. Storage Link Missing

```bash
# Create storage link
php artisan storage:link

# Verify link
ls -la public/storage
```

---

## Security Checklist

- [ ] `APP_DEBUG=false` in `.env`
- [ ] Strong `APP_KEY` generated
- [ ] Database credentials are secure
- [ ] File permissions are correct (755 for directories, 644 for files)
- [ ] Storage directory is writable but secure
- [ ] SSL certificate is installed and working
- [ ] Firewall is configured (UFW/iptables)
- [ ] Regular backups are scheduled
- [ ] `.env` file is not publicly accessible
- [ ] `storage` and `bootstrap/cache` are not publicly accessible

### Firewall Configuration

```bash
# Ubuntu/Debian (UFW)
sudo ufw allow 22/tcp    # SSH
sudo ufw allow 80/tcp    # HTTP
sudo ufw allow 443/tcp   # HTTPS
sudo ufw enable
```

---

## Maintenance Mode

### Enable Maintenance Mode

```bash
php artisan down
```

### Disable Maintenance Mode

```bash
php artisan up
```

### Maintenance Mode with Secret

```bash
# Enable with bypass secret
php artisan down --secret="your-secret-key"

# Access site during maintenance:
# https://yourdomain.com/your-secret-key
```

---

## Update Deployment

When updating the application:

```bash
cd /var/www/travel-cms

# Pull latest changes
git pull origin main

# Install/update dependencies
composer install --optimize-autoloader --no-dev
npm install
npm run build

# Run migrations
php artisan migrate --force

# Clear and cache
php artisan config:clear
php artisan cache:clear
php artisan view:clear
php artisan route:clear

php artisan config:cache
php artisan route:cache
php artisan view:cache
php artisan optimize
```

---

## Performance Optimization

### 1. Enable OPcache

Edit PHP configuration:

```bash
sudo nano /etc/php/8.2/fpm/php.ini
```

Enable and configure OPcache:

```ini
opcache.enable=1
opcache.memory_consumption=128
opcache.interned_strings_buffer=8
opcache.max_accelerated_files=10000
opcache.revalidate_freq=2
opcache.fast_shutdown=1
```

Restart PHP-FPM:

```bash
sudo systemctl restart php8.2-fpm
```

### 2. Enable Gzip Compression (Nginx)

Add to Nginx configuration:

```nginx
gzip on;
gzip_vary on;
gzip_min_length 1024;
gzip_types text/plain text/css text/xml text/javascript application/x-javascript application/xml+rss application/json application/javascript;
```

---

## Support and Documentation

- **Laravel Documentation**: https://laravel.com/docs
- **Nginx Documentation**: https://nginx.org/en/docs/
- **Let's Encrypt**: https://letsencrypt.org/docs/

---

## Quick Deployment Checklist

```bash
# 1. Clone repository
git clone <repository-url> /var/www/travel-cms

# 2. Install dependencies
composer install --optimize-autoloader --no-dev
npm install && npm run build

# 3. Configure environment
cp .env.example .env
php artisan key:generate
# Edit .env with production values

# 4. Setup database
php artisan migrate --force

# 5. Set permissions
sudo chown -R www-data:www-data /var/www/travel-cms
sudo chmod -R 775 storage bootstrap/cache
php artisan storage:link

# 6. Optimize
php artisan config:cache
php artisan route:cache
php artisan view:cache
php artisan optimize

# 7. Configure web server (Nginx/Apache)
# 8. Setup SSL certificate
# 9. Test application
```

---

**Last Updated**: November 2025
**Version**: 1.0

